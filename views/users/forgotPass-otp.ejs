<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify OTP - Reset Password</title>

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="styles/user/forgotPass.css">

</head>

<body>

    <div class="container">

        <h2>Verification Code</h2>
        <p class="desc">We’ve sent a 6-digit verification code to your email. Please enter it below to continue.</p>

        <div class="otp-boxes">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
        </div>

        <button class="verify-btn" onclick="verifyOTP()">Verify</button>

        <div class="links">
            <span>Didn't receive the code? </span>
            <span class="resend" onclick="resendOTP()">Resend</span>
            <div style="margin-top:10px;">
                <span id="timer" style="color:#385723; font-weight:600;"></span>
            </div>
        </div>
        <div>
            <% if (locals.message) { %>
                <div class="error-msg">
                    <%= message %>
                </div>
                <% } %>

        </div>

        <a href="/login" class="return-login">Return to login</a>

    </div>

    <script>
        const inputs = document.querySelectorAll(".otp-input");
        let timerInterval;
        let timeLeft = 60; // 60 seconds

        /* ----------------------------- OTP TIMER ----------------------------- */
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 60;

            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById("timer").innerHTML =
                        "Didn’t receive code? <span class='resend' onclick='resendOTP()'>Resend OTP</span>";
                } else {
                    document.getElementById("timer").innerText =
                        `Resend OTP in 00:${timeLeft < 10 ? "0" + timeLeft : timeLeft}`;
                    timeLeft--;
                }
            }, 1000);
        }

        // Start timer when page loads
        startTimer();


        /* ------------------------ AUTO FOCUS OTP INPUT ----------------------- */
        inputs.forEach((box, index) => {
            box.addEventListener("input", () => {
                if (box.value.length === 1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });

            box.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && box.value === "" && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });


        /* ----------------------------- RESEND OTP ---------------------------- */
        function resendOTP() {
            Swal.fire({
                icon: "info",
                title: "Sending OTP...",
                showConfirmButton: false,
                timer: 1200
            });

            fetch("/forgot-send-otp", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire("Success!", "OTP has been resent to your email.", "success");
                        inputs.forEach(i => i.value = ""); // clear previous input
                        inputs[0].focus();
                        startTimer(); // Restart timer
                    } else {
                        Swal.fire("Error", data.message, "error");
                    }
                });
        }


        /* ----------------------------- VERIFY OTP ---------------------------- */
        function verifyOTP() {
            let otp = "";
            inputs.forEach(inp => otp += inp.value);

            if (otp.length !== 6) {
                return Swal.fire("Invalid", "Please enter all 6 digits!", "warning");
            }

            fetch("/verify-forgot-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ otp })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: "success",
                            title: "OTP Verified!",
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = data.redirectUrl;
                        });
                    } else {
                        Swal.fire("Error", data.message, "error");
                    }
                });
        }
    </script>



</body>

</html>