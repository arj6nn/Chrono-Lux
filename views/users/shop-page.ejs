<%-include("../partials/user/header")%>

  <link rel="stylesheet" href="/styles/user/shop-page.css">

  <!-- MAIN LAYOUT -->
  <div class="shop-main">

    <!-- FILTER SIDEBAR (OFF-CANVAS) -->
    <div id="filterSidebar" class="filter-sidebar">
      <%-include("../partials/user/shop-sidebar")%>
    </div>

    <!-- OVERLAY -->
    <div id="filterOverlay" class="filter-overlay"></div>


    <!-- RIGHT SIDE CONTENT -->
    <div class="shop-content">
      <!-- Page Header (full width) -->
      <div class="page-header">
        <h2>Where the Time Becomes Legacy</h2>
        <p>Discover iconic watches built to endure generations.</p>
      </div>

      <!-- Search and Sort Bar -->
      <div class="search-sort-bar">
        <div class="search-box">
          <input type="text" class="search-input" placeholder="Search watches" autocomplete="off">

          <i class="fa-solid fa-magnifying-glass" onclick="applyFilters()"></i>
        </div>

      </div>

      <section class="products-section">

        <div class="products-grid">

          <% products.forEach(product=> { %>

            <a href="/product/<%= product.id %>" class="product-card">
              <div class="product-image-wrapper">
                <button class="wishlist-btn <%= product.isInWishlist ? 'active' : '' %>"
                  onclick="toggleWishlist(event, '<%= product.id %>', <%= product.totalStock || 0 %>)">
                  <i class="<%= product.isInWishlist ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
                </button>
                <img src="<%= product.image %>" class="product-image" loading="lazy" decoding="async" width="260"
                  height="320" style="object-fit: contain;">
              </div>

              <div class="product-info">
                <div class="product-name">
                  <%= product.productName %>
                </div>
                <div class="product-price">
                  <% if (product.salesPrice> 0) { %>
                    <span class="selling-price">₹ <%= product.salesPrice %></span>
                    <span class="original-price" style="text-decoration: line-through; color:#888; margin-left:6px;">
                      ₹ <%= product.price %>
                    </span>
                    <% } else { %>
                      <span class="selling-price">₹ <%= product.price %></span>
                      <% } %>
                </div>
                <% if (product.appliedOffer) { %>
                  <div class="offer-badge">
                    <%= product.appliedOffer.discountValue %>% OFF
                  </div>
                  <% } %>
                    <% if (product.totalStock===0) { %>
                      <div class="out-of-stock-text">Out of Stock</div>
                      <% } %>
              </div>

            </a>

            <% }) %>

        </div>

        <div class="pagination">

          <!-- PREV -->
          <a class="page-item <%= currentPage === 1 ? 'disabled' : '' %>" href="<%= currentPage === 1 
       ? '#' 
       : `/shop?${new URLSearchParams({ ...(filters || {}), page: currentPage - 1 }).toString()}` %>">
            Prev
          </a>

          <!-- PAGE NUMBERS -->
          <% for (let i=1; i <=totalPages; i++) { %>
            <a class="page-item <%= i === currentPage ? 'active' : '' %>"
              href="/shop?<%= new URLSearchParams({ ...(filters || {}), page: i }).toString() %>">
              <%= i %>
            </a>
            <% } %>

              <!-- NEXT -->
              <a class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>" href="<%= currentPage === totalPages 
       ? '#' 
       : `/shop?${new URLSearchParams({ ...(filters || {}), page: currentPage + 1 }).toString()}` %>">
                Next
              </a>

        </div>


      </section>

    </div>

  </div> <!-- END shop-main -->

  <script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
      const nav = document.querySelector('nav');
      if (!nav) return;
      nav.classList.add('glass-nav');
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.querySelector(".search-input");
      const grid = document.querySelector(".products-grid");

      if (!searchInput || !grid) return;

      //Cache initial products HTML (important)
      let originalGridHTML = grid.innerHTML;

      let debounceTimer = null;

      searchInput.addEventListener("input", () => {
        clearTimeout(debounceTimer);

        const query = searchInput.value.trim();

        debounceTimer = setTimeout(() => {

          //If search box cleared → restore products (NO reload)
          if (query.length === 0) {
            grid.innerHTML = originalGridHTML;
            history.replaceState({}, "", "/shop");
            return;
          }


          fetch(`/shop/live-search?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(products => {
              renderProducts(products);

              //keep search in URL for pagination
              history.replaceState({}, "", `/shop?search=${encodeURIComponent(query)}`);
            })
            .catch(err => {
              console.error("Live search error:", err);
            });


        }, 300); // debounce delay
      });

      function renderProducts(products) {
        grid.innerHTML = "";

        if (!products || products.length === 0) {
          grid.innerHTML = `
          <p class="no-products" style="grid-column: 1 / -1; text-align: center;">
            No results found
          </p>`;
          return;
        }

        products.forEach(p => {
          const priceHTML =
            p.salesPrice > 0
              ? `
              <span class="selling-price">₹ ${p.salesPrice}</span>
              <span class="original-price" style="text-decoration: line-through; color:#888; margin-left:6px;">
                ₹ ${p.price}
              </span>
            `
              : `<span class="selling-price">₹ ${p.price}</span>`;

          grid.insertAdjacentHTML(
            "beforeend",
            `
          <a href="/product/${p.id}" class="product-card">
            <div class="product-image-wrapper"> 
               <button class="wishlist-btn ${p.isInWishlist ? 'active' : ''}" 
                       onclick="toggleWishlist(event, '${p.id}', ${p.totalStock})">
                <i class="${p.isInWishlist ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
              </button>
              <img
                src="${p.image}"
                class="product-image"
                loading="lazy"
                decoding="async"
                style="object-fit: contain;"
              />
            </div>
            <div class="product-info">
              <div class="product-name">${p.productName}</div>
              <div class="product-price">${priceHTML}</div>
              ${p.appliedOffer ? `<div class="offer-badge">${p.appliedOffer.discountValue}% OFF</div>` : ''}
              ${p.totalStock === 0 ? '<div class="out-of-stock-text">Out of Stock</div>' : ''}
            </div>
          </a>
        `
          );
        });
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.querySelector(".products-grid");
      const pagination = document.querySelector(".pagination");

      if (!grid || !pagination) return;

      // Intercept pagination clicks
      pagination.addEventListener("click", async (e) => {
        const link = e.target.closest("a");
        if (!link || link.classList.contains("disabled")) return;

        e.preventDefault();
        const url = link.getAttribute("href");
        if (!url) return;

        loadPage(url, true);
      });

      // Browser back / forward support
      window.addEventListener("popstate", () => {
        loadPage(location.href, false);
      });

      async function loadPage(url, pushState) {
        try {
          grid.classList.add("loading");

          const res = await fetch(url, {
            headers: { Accept: "application/json" }
          });

          const data = await res.json();

          renderPaginatedProducts(data.products);
          renderPagination(data.currentPage, data.totalPages, url);

          if (pushState) history.pushState({}, "", url);

        } catch (err) {
          console.error("Pagination error:", err);
        } finally {
          grid.classList.remove("loading");
        }
      }

      function renderPaginatedProducts(products) {
        if (!products.length) {
          grid.innerHTML = `
        <p style="grid-column:1/-1;text-align:center">
          No products found
        </p>`;
          return;
        }

        grid.innerHTML = products.map(p => {
          const price =
            p.salesPrice > 0
              ? `<span class="selling-price">₹ ${p.salesPrice}</span>
             <span class="original-price" style="text-decoration:line-through;color:#888;margin-left:6px">
               ₹ ${p.price}
             </span>`
              : `<span class="selling-price">₹ ${p.price}</span>`;

          return `
        <a href="/product/${p.id}" class="product-card">
          <div class="product-image-wrapper">
            <button class="wishlist-btn ${p.isInWishlist ? 'active' : ''}" 
                    onclick="toggleWishlist(event, '${p.id}', ${p.totalStock})">
              <i class="${p.isInWishlist ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
            </button>
            <img src="${p.image}" class="product-image" loading="lazy" style="object-fit:contain">
          </div>
          <div class="product-info">
            <div class="product-name">${p.productName}</div>
            <div class="product-price">${price}</div>
            ${p.appliedOffer ? `<div class="offer-badge">${p.appliedOffer.discountValue}% OFF</div>` : ''}
            ${p.totalStock === 0 ? '<div class="out-of-stock-text">Out of Stock</div>' : ''}
          </div>
        </a>`;
        }).join("");
      }

      function renderPagination(currentPage, totalPages, baseUrl) {
        const url = new URL(baseUrl, location.origin);
        const params = Object.fromEntries(url.searchParams.entries());

        pagination.innerHTML = "";

        // Prev
        pagination.innerHTML += `
      <a class="page-item ${currentPage === 1 ? "disabled" : ""}"
         href="/shop?${new URLSearchParams({ ...params, page: currentPage - 1 })}">
        Prev
      </a>`;

        for (let i = 1; i <= totalPages; i++) {
          pagination.innerHTML += `
        <a class="page-item ${i === currentPage ? "active" : ""}"
           href="/shop?${new URLSearchParams({ ...params, page: i })}">
          ${i}
        </a>`;
        }

        // Next
        pagination.innerHTML += `
      <a class="page-item ${currentPage === totalPages ? "disabled" : ""}"
         href="/shop?${new URLSearchParams({ ...params, page: currentPage + 1 })}">
        Next
      </a>`;
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const filterBtn = document.getElementById("filterToggle");
      const sidebar = document.getElementById("filterSidebar");
      const overlay = document.getElementById("filterOverlay");

      if (!filterBtn || !sidebar || !overlay) return;

      function openFilter() {
        sidebar.classList.add("active");
        overlay.classList.add("active");
        filterBtn.classList.add("hidden");
      }

      function closeFilter() {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
        filterBtn.classList.remove("hidden");
      }

      filterBtn.addEventListener("click", openFilter);

      overlay.addEventListener("click", closeFilter);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && sidebar.classList.contains("active")) {
          closeFilter();
        }
      });
    });
  </script>

  <script>
    async function toggleWishlist(event, productId, totalStock) {
      event.preventDefault();   // stop link
      event.stopPropagation();  // stop card click

      const btn = event.currentTarget;
      const icon = btn.querySelector("i");
      const isAdding = !btn.classList.contains("active");

      if (isAdding && totalStock === 0) {
        Toastify({
          text: "Insufficient Stock",
          duration: 2500,
          gravity: "bottom",
          position: "center",
          className: "toastify-glass error",
          stopOnFocus: true
        }).showToast();
        return;
      }

      try {
        const url = isAdding ? `/wishlist/add/${productId}` : `/wishlist/remove/${productId}`;
        const res = await fetch(url, {
          method: "POST",
          headers: {
            'Accept': 'application/json'
          }
        });

        if (res.status === 401) {
          Swal.fire({
            icon: 'info',
            title: 'Login Required',
            text: 'Please login to add items to your wishlist',
            showCancelButton: true,
            confirmButtonText: 'Login Now',
            cancelButtonText: 'Maybe Later',
            customClass: {
              popup: 'glass-popup'
            }
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = '/login';
            }
          });
          return;
        }

        const data = await res.json();

        if (data.success) {
          btn.classList.toggle("active");
          if (isAdding) {
            icon.classList.replace("fa-regular", "fa-solid");
            icon.style.color = "#ef4444";
          } else {
            icon.classList.replace("fa-solid", "fa-regular");
            icon.style.color = "";
          }

          // Update header wishlist count
          const countBadge = document.getElementById("wishlist-count-val");
          if (countBadge && typeof data.wishlistCount !== 'undefined') {
            countBadge.textContent = data.wishlistCount;
            countBadge.style.display = data.wishlistCount > 0 ? "" : "none";
          }

          Toastify({
            text: data.message || (isAdding ? "Added to wishlist" : "Removed from wishlist"),
            duration: 2500,
            gravity: "bottom",
            position: "center",
            className: `toastify-glass ${isAdding ? 'success' : 'error'}`,
            stopOnFocus: true
          }).showToast();
        } else {
          throw new Error(data.message);
        }

      } catch (err) {
        console.error("Wishlist error:", err);
        Toastify({
          text: err.message || "Failed to update wishlist",
          duration: 2500,
          gravity: "bottom",
          position: "center",
          className: "toastify-glass error",
          stopOnFocus: true
        }).showToast();
      }
    }
  </script>



  <button id="filterToggle" class="fixed-filter-btn">
    <i class="fa-solid fa-sliders"></i>
    Filters
  </button>




  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <%-include("../partials/user/footer")%>