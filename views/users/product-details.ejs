<%- include("../partials/user/header") %>

  <link rel="stylesheet" href="/styles/user/header.css">
  <link rel="stylesheet" href="/styles/user/product-details.css">

  <body>


    <% const hasVariants=product.variants && product.variants.length> 0;
      const defaultVariant = hasVariants ? product.variants[0] : null;
      const hasSale =
      defaultVariant &&
      defaultVariant.salesPrice > 0 &&
      defaultVariant.salesPrice < defaultVariant.price; %>


        <!-- PRODUCT SECTION -->
        <div class="product-container">

          <!-- IMAGES -->
          <div class="product-images">

            <!-- BREADCRUMB -->
            <div class="breadcrumb">
              <a href="/shop">Shop</a> /
              <a href="#">
                <%= product.brand.brandName %>
              </a> /
              <span>
                <%= product.productName %>
              </span>
            </div>

            <!-- IMAGES CONTENT WRAPPER -->
            <div class="images-content-wrapper">
              <!-- VARIANT THUMBNAILS (LEFT) -->
              <% if (product.variants.length> 1) { %>
                <div class="thumbnail-list" id="variantThumbnails">
                  <% product.variants.forEach((v, index)=> { %>
                    <div class="thumbnail <%= index === 0 ? 'active' : '' %>" data-variant-index="<%= index %>">
                      <img src="<%= v.images[0] %>" />
                    </div>
                    <% }) %>
                </div>
                <% } %>

                  <!-- IMAGE COLUMN (CENTER) -->
                  <div class="image-column">
                    <!-- MAIN IMAGE -->
                    <div class="main-image image-wrapper">
                      <button class="img-arrow left" id="prevImage">&#10094;</button>
                      <div class="image-zoom-container">
                        <img id="mainProductImage" class="click-zoom-image" src="<%= defaultVariant.images[0] %>"
                          alt="<%= product.productName %>" />
                      </div>
                      <button class="img-arrow right" id="nextImage">&#10095;</button>
                    </div>

                    <!-- IMAGE THUMBNAILS (BELOW MAIN IMAGE) -->
                    <div class="image-thumbnails" id="imageThumbnails">
                      <% defaultVariant.images.forEach((img, index)=> { %>
                        <img src="<%= img %>" class="image-thumb <%= index === 0 ? 'active' : '' %>"
                          data-image-index="<%= index %>" />
                        <% }) %>
                    </div>
                  </div>
            </div>

          </div>


          <!-- PRODUCT INFO -->
          <div class="product-info">

            <h1>
              <%= product.productName %>
            </h1>
            <% if (unavailable) { %>
              <div class="product-unavailable">
                <strong>This product is currently unavailable</strong>
                <p>You can view the details, but purchasing is disabled.</p>
              </div>
              <% } %>


                <!-- SELECTED COLOR -->
                <p id="selectedColor" class="selected-color">
                  Color: <strong>
                    <%= defaultVariant.color %>
                  </strong>
                </p>

                <!-- DIAL SIZE (DISPLAY ONLY) -->
                <p class="dial-info">
                  Dial Size: <strong>
                    <%= defaultVariant.dialSize %>
                  </strong>
                </p>

                <!-- PRICE -->
                <div class="price" id="priceBox">
                  <% if (hasSale) { %>
                    <span class="original-price">â‚¹ <%= defaultVariant.price %></span>
                    <span class="sale-price">â‚¹ <%= defaultVariant.salesPrice.toLocaleString() %></span>
                    <% if (defaultVariant.appliedOffer) { %>
                      <div class="offer-badge">
                        <%= defaultVariant.appliedOffer.discountValue %>% OFF
                      </div>
                      <% } %>
                        <% } else { %>
                          <span class="sale-price">â‚¹ <%= defaultVariant.price.toLocaleString() %></span>
                          <% } %>
                </div>

                <!-- QUANTITY -->
                <% if (!unavailable) { %>
                  <div class="quantity-selector">
                    <label>Quantity:</label>
                    <div class="quantity-controls">
                      <button id="decrease">-</button>
                      <input type="number" id="quantity" value="1" min="1" readonly>
                      <button id="increase">+</button>
                    </div>
                  </div>
                  <% } %>


                    <!-- ACTION BUTTONS -->
                    <div class="action-buttons">
                      <% if (unavailable) { %>
                        <button class="btn btn-disabled" disabled>
                          Product Unavailable
                        </button>

                        <% } else if (defaultVariant.stock> 0) { %>
                          <button class="btn btn-add-cart" data-variant-id="<%= defaultVariant._id %>">
                            Add to Cart
                          </button>

                          <% if (isInWishlist) { %>
                            <button class="btn btn-wishlist active" data-product-id="<%= product._id %>" disabled
                              style="color: #ffcc00; border-color: #ffcc00;">
                              <i class="fa-solid fa-heart"></i>
                              WISHLISTED
                            </button>
                            <% } else { %>
                              <button class="btn btn-wishlist" data-product-id="<%= product._id %>">
                                <i class="fa-regular fa-heart"></i>
                                Add to Wishlist
                              </button>
                              <% } %>



                                <% } else { %>
                                  <button class="btn btn-disabled" disabled>
                                    Out of Stock
                                  </button>
                                  <% } %>
                    </div>


                    <!-- DESCRIPTION -->
                    <div class="product-description">
                      <h3>Product Description</h3>
                      <p>
                        <%= product.description %>
                      </p>
                    </div>

                    <!-- FEATURES -->
                    <div class="features">
                      <div class="feature">
                        <div class="feature-title">Shipping & Returns</div>
                        <div class="feature-desc">
                          Free insured shipping worldwide. 30-day return policy.
                        </div>
                      </div>
                      <div class="feature">
                        <div class="feature-title">Returns & Exchange</div>
                        <div class="feature-desc">
                          Easy returns within 30 days with original packaging.
                        </div>
                      </div>
                      <div class="feature">
                        <div class="feature-title">Product Care</div>
                        <div class="feature-desc">
                          Professional servicing recommended every 5 years.
                        </div>
                      </div>
                    </div>

          </div>
        </div>

        <!-- CUSTOMER REVIEWS -->
        <section class="customer-reviews">
          <div class="reviews-container">

            <h2 class="reviews-title">Customer Reviews</h2>

            <!-- SUMMARY -->
            <div class="review-summary">
              <div class="rating-score">4.7</div>

              <div>
                <div class="rating-stars">â˜…â˜…â˜…â˜…â˜…</div>
                <span class="review-count">Based on 3 reviews</span>
              </div>
            </div>

            <!-- REVIEW CARD -->
            <div class="review-card">
              <div class="review-top">
                <div>
                  <strong>Michael Thompson</strong>
                  <div class="review-stars">â˜…â˜…â˜…â˜…â˜…</div>
                </div>

                <div class="review-meta">
                  <span class="verified">Verified Purchase</span>
                  <span class="review-date">Jan 15, 2024</span>
                </div>
              </div>

              <p class="review-title">Exceptional timepiece</p>
              <p class="review-text">
                The craftsmanship is outstanding. The watch feels solid and luxurious on
                the wrist. The automatic movement keeps perfect time.
              </p>
            </div>

            <div class="review-card">
              <div class="review-top">
                <div>
                  <strong>Sarah Chen</strong>
                  <div class="review-stars">â˜…â˜…â˜…â˜…â˜…</div>
                </div>

                <div class="review-meta">
                  <span class="verified">Verified Purchase</span>
                  <span class="review-date">Jan 10, 2024</span>
                </div>
              </div>

              <p class="review-title">Worth every penny</p>
              <p class="review-text">
                I have been looking for the perfect dive watch for months. This exceeded
                all my expectations.
              </p>
            </div>

            <div class="review-card">
              <div class="review-top">
                <div>
                  <strong>James Rodriguez</strong>
                  <div class="review-stars">â˜…â˜…â˜…â˜…â˜†</div>
                </div>

                <div class="review-meta">
                  <span class="verified">Verified Purchase</span>
                  <span class="review-date">Jan 5, 2024</span>
                </div>
              </div>

              <p class="review-title">Beautiful watch, minor concerns</p>
              <p class="review-text">
                Stunning piece. Bracelet adjustment took time, but once fitted itâ€™s
                incredibly comfortable.
              </p>
            </div>

            <button class="write-review-btn">Write a Review</button>

          </div>
        </section>


        <!-- RELATED PRODUCTS -->
        <% if (relatedProducts && relatedProducts.length> 0) { %>
          <div class="related-products">
            <h2>You may also like</h2>

            <div class="products-grid">
              <% relatedProducts.forEach(p=> {
                const v = p.variants?.[0];
                if (!v) return; // safety
                %>
                <a href="/product/<%= p._id %>" class="product-card">
                  <div class="product-card-image">
                    <img src="<%= v.images?.[0] || '/images/placeholder.png' %>" alt="<%= p.productName %>">
                  </div>

                  <div class="product-card-category">
                    <%= p.brand?.brandName %>
                  </div>

                  <div class="product-card-name">
                    <%= p.productName %>
                  </div>

                  <div class="product-card-price">
                    â‚¹ <%= v.salesPrice> 0 ? v.salesPrice : v.price %>
                      <% if (v.salesPrice> 0) { %>
                        <span class="original-price" style="font-size: 10px; margin-left: 5px;">â‚¹ <%= v.price %></span>
                        <% } %>
                  </div>
                  <% if (v.appliedOffer) { %>
                    <div class="offer-badge">
                      <%= v.appliedOffer.discountValue %>% OFF
                    </div>
                    <% } %>
                </a>
                <% }) %>
            </div>
          </div>
          <% } %>
  </body>
  <script>
    const PRODUCT_UNAVAILABLE = <%= unavailable ? "true" : "false" %>;
  </script>

  <script>
    const PRODUCT_ID = "<%= product._id %>";
  </script>
  <script>
    const IS_LOGGED_IN = <%= (locals.user && locals.user._id) ? "true" : "false" %>;
    let IS_IN_WISHLIST = <%= isInWishlist ? "true" : "false" %>;
  </script>


  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const glassAlert = (icon, title, text) => {
      Swal.fire({
        icon,
        title,
        text,
        customClass: {
          popup: 'glass-alert'
        },
        confirmButtonText: 'OK'
      });
    };
  </script>

  <!-- JS -->
  <!-- Replace ALL your script tags at the bottom with this: -->

  <!-- DATA CARRIER -->
  <script id="product-variants-json" type="application/json">
    <%- JSON.stringify(product.variants) %>
  </script>

  <!-- MAIN VARIANT & IMAGE NAVIGATION SCRIPT -->
  <script>
    let resetProductZoom; // Declare globally

    document.addEventListener("DOMContentLoaded", () => {

      // Robust data loading
      let variants = [];
      try {
        const rawData = document.getElementById("product-variants-json").textContent;
        variants = JSON.parse(rawData);
        console.log("Variants loaded successfully:", variants.length);
      } catch (err) {
        console.error("Failed to parse variant data:", err);
      }

      let currentVariantIndex = 0;
      let currentImageIndex = 0;

      const mainImage = document.getElementById("mainProductImage");
      const imageThumbContainer = document.getElementById("imageThumbnails");
      const prevBtn = document.getElementById("prevImage");
      const nextBtn = document.getElementById("nextImage");
      const priceBox = document.getElementById("priceBox");
      const colorLabel = document.getElementById("selectedColor");
      const actionButtons = document.querySelector(".action-buttons");

      // INIT / RENDER FUNCTION
      function loadVariant(index) {
        if (!variants || !variants[index]) return;

        const v = variants[index];
        currentVariantIndex = index;
        currentImageIndex = 0;

        // Reset zoom when changing variant
        if (typeof resetProductZoom === 'function') {
          resetProductZoom();
        }

        // Main image
        if (mainImage && v.images && v.images.length > 0) {
          mainImage.src = v.images[0];
        }

        // Thumbnails
        if (imageThumbContainer) {
          imageThumbContainer.innerHTML = "";
          if (v.images) {
            v.images.forEach((img, i) => {
              const thumb = document.createElement("img");
              thumb.src = img;
              thumb.className = "image-thumb" + (i === 0 ? " active" : "");
              thumb.addEventListener("click", () => {
                currentImageIndex = i;
                updateMainImage();
                if (typeof resetProductZoom === 'function') {
                  resetProductZoom();
                }
              });
              imageThumbContainer.appendChild(thumb);
            });
          }
        }

        // Price
        if (priceBox) {
          const appliedOffer = v.appliedOffer;
          // construct offer badge HTML safely
          const offerBadgeHtml = appliedOffer
            ? `<div class="offer-badge">${appliedOffer.discountValue}% OFF</div>`
            : '';

          if (v.salesPrice > 0 && v.salesPrice < v.price) {
            // Sale price
            priceBox.innerHTML = `
                    <span class="original-price">â‚¹ ${v.price.toLocaleString()}</span>
                    <span class="sale-price">â‚¹ ${v.salesPrice.toLocaleString()}</span>
                    ${offerBadgeHtml}
                `;
          } else {
            // Regular price
            priceBox.innerHTML = `
                    <span class="sale-price">â‚¹ ${v.price.toLocaleString()}</span>
                `;
          }
        }

        // Color
        if (colorLabel) {
          colorLabel.innerHTML = `Color: <strong>${v.color}</strong>`;
        }

        // Stock / availability buttons
        if (actionButtons) {
          if (PRODUCT_UNAVAILABLE) {
            actionButtons.innerHTML =
              `<button class="btn btn-disabled" disabled>
                Product Unavailable
                </button>`;
          } else if (v.stock > 0) {
            actionButtons.innerHTML = `
                    <button class="btn btn-add-cart" data-variant-id="${v._id}">
                        Add to Cart
                    </button>
                    ${IS_IN_WISHLIST ? `
                      <button class="btn btn-wishlist active" data-product-id="${PRODUCT_ID}" disabled style="color: #ffcc00; border-color: #ffcc00;">
                          <i class="fa-solid fa-heart"></i> WISHLISTED
                      </button>
                    ` : `
                      <button class="btn btn-wishlist" data-product-id="${PRODUCT_ID}">
                          <i class="fa-regular fa-heart"></i> Add to Wishlist
                      </button>
                    `}`;
          } else {
            actionButtons.innerHTML = `<button class="btn btn-disabled" disabled>Out of Stock</button>`;
          }
        }
      }

      function updateMainImage() {
        if (!variants[currentVariantIndex]) return;
        const imgs = variants[currentVariantIndex].images;
        if (mainImage) mainImage.src = imgs[currentImageIndex];
        document.querySelectorAll(".image-thumb").forEach((t, i) => {
          t.classList.toggle("active", i === currentImageIndex);
        });
      }

      // VARIANT CLICK - Using Event Delegation
      const variantContainer = document.getElementById("variantThumbnails");

      if (variantContainer) {
        variantContainer.addEventListener("click", (e) => {
          // Find the closest thumbnail element
          const thumbnail = e.target.closest("[data-variant-index]");

          if (thumbnail) {
            e.preventDefault();
            e.stopPropagation(); // Stop bubbling

            const variantIndex = Number(thumbnail.dataset.variantIndex);
            console.log("Variant clicked:", variantIndex);

            // Remove active from all
            document
              .querySelectorAll("[data-variant-index]")
              .forEach(t => t.classList.remove("active"));

            // Add active to clicked
            thumbnail.classList.add("active");

            // Load the variant
            loadVariant(variantIndex);
          }
        });
      }

      // ARROWS
      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          const v = variants[currentVariantIndex];
          if (!v || !v.images) return;
          const imgs = v.images;
          currentImageIndex = (currentImageIndex - 1 + imgs.length) % imgs.length;
          updateMainImage();
          if (typeof resetProductZoom === 'function') resetProductZoom();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          const v = variants[currentVariantIndex];
          if (!v || !v.images) return;
          const imgs = v.images;
          currentImageIndex = (currentImageIndex + 1) % imgs.length;
          updateMainImage();
          if (typeof resetProductZoom === 'function') resetProductZoom();
        });
      }

      // Initial Load
      if (variants.length > 0) {
        loadVariant(0);
      }

    });
  </script>

  <!-- NAV GLASS EFFECT -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const nav = document.querySelector('nav');
      if (!nav) return;
      nav.classList.add('glass-nav');
    });
  </script>

  <!-- IMAGE ZOOM FUNCTIONALITY -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const zoomContainer = document.querySelector(".image-zoom-container");
      const zoomImage = document.getElementById("mainProductImage");

      if (!zoomContainer || !zoomImage) return;

      let isZoomed = false;

      // Define reset function and assign to global
      resetProductZoom = function () {
        isZoomed = false;
        zoomImage.classList.remove("zoomed");
        zoomImage.style.transform = "scale(1)";
        zoomImage.style.transformOrigin = "center center";
      };

      // Click to toggle zoom
      zoomContainer.addEventListener("click", (e) => {
        isZoomed = !isZoomed;
        zoomImage.classList.toggle("zoomed", isZoomed);

        if (isZoomed) {
          const rect = zoomContainer.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          zoomImage.style.transformOrigin = `${x}% ${y}%`;
          zoomImage.style.transform = "scale(2.5)";
        } else {
          zoomImage.style.transformOrigin = "center center";
          zoomImage.style.transform = "scale(1)";
        }
      });

      // Optional: Hover zoom effect (only when zoomed)
      zoomContainer.addEventListener("mousemove", (e) => {
        if (!isZoomed) return;

        const rect = zoomContainer.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;

        zoomImage.style.transformOrigin = `${x}% ${y}%`;
      });

      // Reset on mouse leave
      zoomContainer.addEventListener("mouseleave", () => {
        if (isZoomed) {
          resetProductZoom();
        }
      });
    });
  </script>

  <script>
    const decreaseBtn = document.getElementById("decrease");
    const increaseBtn = document.getElementById("increase");
    const quantityInput = document.getElementById("quantity");

    if (decreaseBtn && increaseBtn && quantityInput) {
      increaseBtn.addEventListener("click", () => {
        quantityInput.value = parseInt(quantityInput.value) + 1;
      });

      decreaseBtn.addEventListener("click", () => {
        const currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
          quantityInput.value = currentValue - 1;
        }
      });
    }

  </script>

  <script>
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".btn-wishlist");
      if (!btn) return;

      // ðŸ” login check
      if (typeof IS_LOGGED_IN === "undefined" || !IS_LOGGED_IN) {
        Swal.fire({
          icon: 'info',
          title: 'Login Required',
          text: 'Please login to add items to your wishlist',
          showCancelButton: true,
          confirmButtonText: 'Login Now',
          cancelButtonText: 'Maybe Later',
          customClass: {
            popup: 'glass-popup'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/login';
          }
        });
        return;
      }

      // prevent double click
      if (btn.classList.contains("loading")) return;
      btn.classList.add("loading");

      const productId = btn.dataset.productId;

      try {
        const res = await fetch(`/wishlist/add/${productId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          }
        });

        const data = await res.json();

        if (data.success) {
          btn.classList.add("active");
          btn.innerHTML = `<i class="fa-solid fa-heart"></i> WISHLISTED`;
          btn.disabled = true;
          btn.style.color = "#ffcc00";
          btn.style.borderColor = "#ffcc00";

          // Update global state for variant switching
          if (typeof IS_IN_WISHLIST !== 'undefined') {
            window.IS_IN_WISHLIST = true;
            IS_IN_WISHLIST = true;
          }

          // sync navbar counts
          const wBadge = document.getElementById("wishlist-count-val");
          if (wBadge && typeof data.wishlistCount !== 'undefined') {
            wBadge.textContent = data.wishlistCount;
            wBadge.style.display = data.wishlistCount > 0 ? "" : "none";
          }

          Toastify({
            text: "Added to wishlist",
            duration: 2500,
            gravity: "bottom",
            position: "center",
            className: "toastify-glass success",
            stopOnFocus: true
          }).showToast();
        } else {
          btn.classList.remove("loading");
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: data.message || "Failed to add to wishlist",
            customClass: { popup: 'glass-popup' }
          });
        }

      } catch (err) {
        console.error(err);
        btn.classList.remove("loading");
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: "Something went wrong",
          customClass: { popup: 'glass-popup' }
        });
      }
    });
  </script>



  <script>
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".btn-add-cart");
      if (!btn) return;

      if (typeof IS_LOGGED_IN === "undefined" || !IS_LOGGED_IN) {
        Swal.fire({
          icon: 'info',
          title: 'Login Required',
          text: 'Please login to add items to your cart',
          showCancelButton: true,
          confirmButtonText: 'Login Now',
          cancelButtonText: 'Maybe Later',
          customClass: {
            popup: 'glass-popup'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/login';
          }
        });
        return;
      }

      if (PRODUCT_UNAVAILABLE) {
        Swal.fire({
          icon: "info",
          title: "Product Unavailable",
          text: "This product cannot be purchased right now.",
          customClass: { popup: "glass-alert" }
        });
        return;
      }


      const variantId = btn.dataset.variantId;
      const quantity = parseInt(document.getElementById("quantity").value) || 1;

      if (!variantId) {
        Swal.fire({
          icon: "warning",
          title: "Variant not selected",
          customClass: { popup: "glass-alert" }
        });
        return;
      }

      try {
        const res = await fetch("/cart/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({
            productId: PRODUCT_ID,
            variantId,
            quantity
          })
        });

        const data = await res.json();

        if (data.success) {
          Toastify({
            text: "Added to Cart",
            duration: 2500,
            gravity: "bottom",
            position: "center",
            className: "toastify-glass success",
            stopOnFocus: true
          }).showToast();

          const cBadge = document.getElementById("cart-count-val");
          if (cBadge && typeof data.cartCount !== 'undefined') {
            cBadge.textContent = data.cartCount;
            cBadge.style.display = data.cartCount > 0 ? "" : "none";
          }

          const wBadge = document.getElementById("wishlist-count-val");
          if (wBadge && typeof data.wishlistCount !== 'undefined') {
            wBadge.textContent = data.wishlistCount;
            wBadge.style.display = data.wishlistCount > 0 ? "" : "none";
          }

          // Reset wishlist button if it was in 'WISHLISTED' state
          const wishlistBtn = document.querySelector(".btn-wishlist");
          if (wishlistBtn && wishlistBtn.classList.contains("active")) {
            wishlistBtn.classList.remove("active");
            wishlistBtn.disabled = false;
            wishlistBtn.style.color = "";
            wishlistBtn.style.borderColor = "";
            wishlistBtn.innerHTML = '<i class="fa-regular fa-heart"></i> Add to Wishlist';
            if (typeof IS_IN_WISHLIST !== 'undefined') {
              window.IS_IN_WISHLIST = false;
              IS_IN_WISHLIST = false;
            }
          }

        } else {
          Swal.fire({
            icon: "error",
            title: data.message || "Failed to add",
            customClass: { popup: "glass-popup" }
          });
        }
      } catch (err) {
        console.error(err);
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <%- include("../partials/user/footer") %>
    </body>

    </html>