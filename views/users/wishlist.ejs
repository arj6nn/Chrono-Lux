<%- include("../partials/user/header") %>

  <link rel="stylesheet" href="/styles/user/wishlist.css">

  <main class="container wishlist-page">

    <header class="page-header">
      <h1>Wishlist</h1>
      <p class="item-count">
        <%= wishlist.products.length %> Item<%= wishlist.products.length !==1 ? "s" : "" %>
      </p>
    </header>

    <% if (wishlist.products.length===0) { %>

      <!-- EMPTY STATE -->
      <div class="empty-wishlist">
        <p>Your wishlist is empty üíï</p>
        <a href="/shop" class="continue-shopping">Continue Shopping</a>
      </div>

      <% } else { %>

        <!-- WISHLIST GRID -->
        <section class="wishlist-grid">

          <% wishlist.products.forEach(product=> {
            const variant = product.variants?.[0];
            const price =
            variant?.salesPrice > 0
            ? variant.salesPrice
            : variant?.price;
            %>

            <div class="wishlist-card" data-id="<%= product._id %>" data-variant-id="<%= variant?._id %>">


              <!-- REMOVE -->
              <button class="remove-btn" aria-label="Remove item">&times;</button>

              <!-- IMAGE -->
              <div class="image-wrapper">
                <img src="<%= variant?.images?.[0] || '/images/placeholder.png' %>" alt="<%= product.productName %>">
              </div>

              <!-- DETAILS -->
              <div class="card-details">
                <h3>
                  <%= product.productName %>
                </h3>

                <% const hasOffer=variant.appliedOffer || (variant.salesPrice> 0 && variant.salesPrice < variant.price);
                    const currentPrice=hasOffer ? variant.salesPrice : variant.price; const originalPrice=variant.price;
                    %>

                    <div class="price-container" style="display: flex; flex-direction: column; gap: 4px;">

                      <% if (hasOffer) { %>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span class="current-price" style="font-weight: 600; color: #fff;">‚Çπ <%=
                              currentPrice.toLocaleString("en-IN") %></span>
                          <span class="original-price"
                            style="text-decoration: line-through; color: #888; font-size: 0.9em;">‚Çπ <%=
                              originalPrice.toLocaleString("en-IN") %></span>
                        </div>

                        <% if (variant.appliedOffer) { %>
                          <span class="offer-badge"
                            style="background: #2E4235; color: #4ade80; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #2E4235; width: fit-content;">
                            <%= variant.appliedOffer.discountValue %>% OFF
                          </span>
                          <% } else { %>
                            <!-- Simple sale without explicit offer name (manual sale price) -->
                            <span class="offer-badge" style="color: #ef4444; font-size: 0.8em;">Sale</span>
                            <% } %>

                              <% } else { %>
                                <p class="price" style="margin: 0;">
                                  ‚Çπ <%= currentPrice.toLocaleString("en-IN") %>
                                </p>
                                <% } %>

                    </div>

                    <button class="add-to-bag">
                      Add to Cart
                    </button>
              </div>

            </div>

            <% }) %>

        </section>

        <footer class="wishlist-footer">
          <a href="/shop" class="continue-shopping">Continue Shopping</a>
        </footer>

        <% } %>

  </main>

  <%- include("../partials/user/footer") %>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const nav = document.querySelector('nav');
        if (nav) nav.classList.add('glass-nav');
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {

        // REMOVE FROM WISHLIST
        document.querySelectorAll(".remove-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const card = btn.closest(".wishlist-card");
            const productId = card.dataset.id;

            const res = await fetch(`/wishlist/remove/${productId}`, {
              method: "POST",
              credentials: "include"
            });

            const data = await res.json();
            if (data.success) {
              card.remove();
              updateWishlistUI(data.wishlistCount, data.cartCount);
              Toastify({
                text: "Removed from wishlist",
                duration: 2500,
                gravity: "bottom",
                position: "center",
                className: "toastify-glass error",
                stopOnFocus: true
              }).showToast();
            }
          });
        });

        function updateWishlistUI(wishlistCount, cartCount) {
          // Update header wishlist badge
          const wBadge = document.getElementById("wishlist-count-val");
          if (wBadge && typeof wishlistCount !== 'undefined') {
            wBadge.textContent = wishlistCount;
            wBadge.style.display = wishlistCount > 0 ? "" : "none";
          }

          // Update header cart badge
          const cBadge = document.getElementById("cart-count-val");
          if (cBadge && typeof cartCount !== 'undefined') {
            cBadge.textContent = cartCount;
            cBadge.style.display = cartCount > 0 ? "" : "none";
          }

          // Update page-level item count text
          const countText = document.querySelector(".item-count");
          if (countText && typeof wishlistCount !== 'undefined') {
            countText.textContent = `${wishlistCount} Item${wishlistCount !== 1 ? 's' : ''}`;
          }

          // Handle empty state transition
          if (wishlistCount === 0) {
            const container = document.querySelector(".wishlist-page");
            if (container) {
              container.innerHTML = `
                <header class="page-header">
                  <h1>Wishlist</h1>
                  <p class="item-count">0 Items</p>
                </header>
                <div class="empty-wishlist">
                  <p>Your wishlist is empty ‚ù§Ô∏è</p>
                  <a href="/shop" class="continue-shopping">Continue Shopping</a>
                </div>
              `;
            }
          }
        }

        // ADD TO CART FROM WISHLIST
        document.querySelectorAll(".add-to-bag").forEach(btn => {
          btn.addEventListener("click", async () => {
            const card = btn.closest(".wishlist-card");

            const productId = card.dataset.id;
            const variantId = card.dataset.variantId;

            try {
              const res = await fetch("/cart/add", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  productId,
                  variantId,
                  quantity: 1
                })
              });

              const data = await res.json();

              if (data.success) {
                card.remove();
                updateWishlistUI(data.wishlistCount, data.cartCount);
                Toastify({
                  text: "Added to cart",
                  duration: 2500,
                  gravity: "bottom",
                  position: "center",
                  className: "toastify-glass success",
                  stopOnFocus: true
                }).showToast();
              } else {
                Toastify({
                  text: data.message || "Failed to add to cart",
                  duration: 2500,
                  gravity: "bottom",
                  position: "center",
                  className: "toastify-glass error",
                  stopOnFocus: true
                }).showToast();
              }
            } catch (err) {
              console.error(err);
              Toastify({
                text: "Something went wrong",
                duration: 2500,
                gravity: "bottom",
                position: "center",
                className: "toastify-glass error",
                stopOnFocus: true
              }).showToast();
            }
          });
        });

      });
    </script>