<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="/styles/admin/dashboard.css">
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <%- include('../partials/admin/sidebar') %>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Header -->
                <div class="header">
                    <div class="header-title">Welcome back, admin@chrono.com!</div>
                    <div class="header-subtitle">Here's your business overview for today</div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">‚Çπ</div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value">‚Çπ<%= totalRevenue.toLocaleString() %>
                        </div>
                        <div class="stat-change">Total revenue from delivered orders</div>
                    </div>

                    <div class="stat-card blue">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value">
                            <%= totalOrders %>
                        </div>
                        <div class="stat-change">Orders placed by customers</div>
                    </div>

                    <div class="stat-card purple">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-label">Active Users</div>
                        <div class="stat-value">
                            <%= totalUsers %>
                        </div>
                        <div class="stat-change">Verified customer accounts</div>
                    </div>

                    <div class="stat-card orange">
                        <div class="stat-icon">üè∑Ô∏è</div>
                        <div class="stat-label">Listed Products</div>
                        <div class="stat-value">
                            <%= totalProducts %>
                        </div>
                        <div class="stat-change">Across all categories</div>
                    </div>
                </div>

                <!-- Dashboard Content Grid (Row 1) -->
                <div class="dashboard-content-grid">
                    <!-- Left Column (Chart) -->
                    <div class="dashboard-left-col">
                        <!-- Order Status Distribution -->
                        <div class="chart-card">
                            <div class="chart-title">
                                <div class="chart-icon">üìä</div>
                                Order Status Distribution
                            </div>
                            <div class="pie-chart-container">
                                <canvas id="orderChart"></canvas>
                            </div>
                            <div class="chart-legend">
                                <% const statusColors={ 'Cancelled' : '#ef4444' , 'Pending' : '#f59e0b' , 'Delivered'
                                    : '#10b981' , 'Shipped' : '#a855f7' , 'Processing' : '#3b82f6' , 'Return Requested'
                                    : '#6b7280' , 'Cancellation Requested' : '#ec4899' };
                                    orderStatusData.forEach(status=> {
                                    %>
                                    <div class="legend-item">
                                        <div class="legend-color"
                                            style="background-color: <%= statusColors[status._id] || '#9ca3af' %>;">
                                        </div>
                                        <span>
                                            <%= status._id %> (<%= status.count %>)
                                        </span>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (Brands) -->
                    <div class="dashboard-right-col">
                        <!-- Top Brands -->
                        <div class="brands-card" style="height: 477px;">
                            <div class="chart-title">
                                <div class="chart-icon">‚≠ê</div>
                                Top Brands
                            </div>
                            <ul class="brand-list">
                                <% if (topBrands && topBrands.length> 0) { %>
                                    <% topBrands.forEach((brand, index)=> { %>
                                        <li class="brand-item">
                                            <div class="brand-rank">
                                                <%= index + 1 %>
                                            </div>
                                            <div class="brand-logo">
                                                <%= brand.brandDetails.brandName ?
                                                    brand.brandDetails.brandName.charAt(0) : 'B' %>
                                            </div>
                                            <div class="brand-info">
                                                <div class="brand-name">
                                                    <%= brand.brandDetails.brandName || 'Unknown Brand' %>
                                                </div>
                                                <div class="brand-ranking">Sold: <%= brand.totalSold %> units</div>
                                            </div>
                                            <div class="brand-status">
                                                <%= brand.brandDetails.isBlocked ? 'Blocked' : 'Active' %>
                                            </div>
                                        </li>
                                        <% }) %>
                                            <% } else { %>
                                                <li class="brand-item">No data available</li>
                                                <% } %>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Equal Grid (Row 2: Products & Categories) -->
                <div class="dashboard-equal-grid">
                    <!-- Top Products -->
                    <div class="products-card">
                        <div class="chart-title">
                            <div class="chart-icon">‚≠ê</div>
                            Top Products
                        </div>
                        <ul class="product-list">
                            <% if (topProducts && topProducts.length> 0) { %>
                                <% topProducts.forEach((product, index)=> { %>
                                    <li class="product-item">
                                        <div class="product-rank">
                                            <%= index + 1 %>
                                        </div>
                                        <div class="product-image">
                                            <% let imgUrl='/images/placeholder.png' ; if
                                                (product.productDetails.variants && product.productDetails.variants[0]
                                                && product.productDetails.variants[0].images &&
                                                product.productDetails.variants[0].images[0]) {
                                                imgUrl=product.productDetails.variants[0].images[0]; if
                                                (!imgUrl.startsWith('http')) { imgUrl='/uploads/products/' + imgUrl; } }
                                                %>
                                                <img src="<%= imgUrl %>" alt=""
                                                    style="width: 30px; height: 30px; border-radius: 4px; object-fit: cover;">
                                        </div>
                                        <div class="product-info">
                                            <div class="product-name">
                                                <%= product.productDetails.productName %>
                                            </div>
                                            <div class="product-category">Sold: <%= product.totalSold %> units</div>
                                        </div>
                                        <div class="product-status">
                                            <%= product.productDetails.isBlocked ? 'Blocked' : 'Active' %>
                                        </div>
                                    </li>
                                    <% }) %>
                                        <% } else { %>
                                            <li class="product-item">No data available</li>
                                            <% } %>
                        </ul>
                    </div>

                    <!-- Top Categories -->
                    <div class="categories-card">
                        <div class="chart-title">
                            <div class="chart-icon">üìÅ</div>
                            Top Categories
                        </div>
                        <ul class="category-list">
                            <% if (topCategories && topCategories.length> 0) { %>
                                <% topCategories.forEach((category, index)=> { %>
                                    <li class="category-item">
                                        <div class="category-rank">
                                            <%= index + 1 %>
                                        </div>
                                        <div class="category-image">
                                            <img src="<%= category.categoryDetails.categoryImage || '/images/placeholder.png' %>"
                                                alt="<%= category.categoryDetails.name %>"
                                                style="width: 30px; height: 30px; border-radius: 4px; object-fit: cover;">
                                        </div>
                                        <div class="category-info">
                                            <div class="category-name">
                                                <%= category.categoryDetails.name %>
                                            </div>
                                            <div class="category-sales">Sold: <%= category.totalSold %> units</div>
                                        </div>
                                        <div class="category-status">
                                            <%= category.categoryDetails.isListed ? 'Active' : 'Unlisted' %>
                                        </div>
                                    </li>
                                    <% }) %>
                                        <% } else { %>
                                            <li class="category-item">No data available</li>
                                            <% } %>
                        </ul>
                    </div>
                </div>

                <!-- Recent Orders Table (Full Width) -->
                <div class="orders-section">
                    <div class="orders-table">
                        <div class="orders-header">
                            <div class="orders-title">
                                <span>üìã</span>
                                Recent Orders
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Product</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (recentOrders && recentOrders.length> 0) { %>
                                        <% recentOrders.forEach(order=> { %>
                                            <tr>
                                                <td>
                                                    <%= order.orderId %>
                                                </td>
                                                <td>
                                                    <%= order.userId ? order.userId.name : 'Unknown' %>
                                                </td>
                                                <td>
                                                    <%= order.orderedItems.length %> items
                                                </td>
                                                <td>‚Çπ<%= order.finalAmount.toLocaleString() %>
                                                </td>
                                                <td><span
                                                        class="status-badge status-<%= order.orderStatus.toLowerCase().replace(' ', '-') %>">
                                                        <%= order.orderStatus %>
                                                    </span></td>
                                                <td>
                                                    <%= new Date(order.createdAt).toLocaleDateString() %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="6" style="text-align: center;">No recent orders
                                                        </td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
    </div>

    <script>
        // Order Status Distribution Chart
        const ctx = document.getElementById('orderChart').getContext('2d');
        const orderData = <%- JSON.stringify(orderStatusData) %>;
        const statusColorsArr = {
            'Cancelled': '#ef4444',
            'Pending': '#f59e0b',
            'Delivered': '#10b981',
            'Shipped': '#a855f7',
            'Processing': '#3b82f6',
            'Return Requested': '#6b7280',
            'Cancellation Requested': '#ec4899'
        };

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: orderData.map(d => d._id),
                datasets: [{
                    data: orderData.map(d => d.count),
                    backgroundColor: orderData.map(d => statusColorsArr[d._id] || '#9ca3af'),
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            }
        });
    </script>
</body>

</html>