<%- include('../partials/admin/sidebar') %>

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/admin/brand-management.css">

    <div class="main">
        <p class="page-title">Brands</p>
        <p class="page-sub">Manage your product brands</p>

<div class="top-bar">

    <!-- LEFT : SEARCH -->
    <form method="GET" action="/admin/brands" class="brand-search">
        <input
            type="text"
            name="search"
            placeholder="Search brand..."
            value="<%= search %>"
        >
        <button type="submit">Search</button>

        <% if (search && search.trim() !== "") { %>
            <a href="/admin/brands" class="reset-btn">Reset</a>
        <% } %>
    </form>

    <!-- RIGHT : ADD BRAND -->
    <button class="add-brand-btn" onclick="openAddBrandModal()">
        <i class="ri-add-line"></i> Add Brand
    </button>

</div>

        <!-- TABLE -->
        <table class="brand-table">
            <thead>
             <tr>
                <th>Logo</th>
                <th>Brand Name</th>
                <th>Products</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>


<tbody>
  <% if (brands.length === 0) { %>
    <tr>
      <td colspan="5" style="text-align:center; padding:20px;">
        No brands found
      </td>
    </tr>
  <% } else { %>
    <% brands.forEach(brand => { %>
      <tr>
        <td class="brand-logo">
          <img src="<%= brand.brandImage[0] %>" alt="Brand Logo">
        </td>

        <td><%= brand.brandName %></td>

        <td><%= brand.productCount %> products</td>

        <td>
          <% if (brand.isBlocked) { %>
            <span class="status blocked">Blocked</span>
          <% } else { %>
            <span class="status active">Active</span>
          <% } %>
        </td>

        <td class="actions">
          <i class="ri-edit-2-line edit"
             onclick="openEditModal('<%= brand._id %>', '<%= brand.brandName %>')">
          </i>

          <% if (!brand.isBlocked) { %>
            <i class="ri-forbid-line delete"
               title="Block Brand"
               onclick="blockBrand('<%= brand._id %>', '<%= brand.brandName %>')">
            </i>
          <% } else { %>
            <i class="ri-checkbox-circle-line edit"
               title="Unblock Brand"
               onclick="unblockBrand('<%= brand._id %>', '<%= brand.brandName %>')">
            </i>
          <% } %>
        </td>
      </tr>
    <% }) %>
  <% } %>
</tbody>


        </table>
        
<% if (totalPages > 1) { %>
<div class="pagination-wrapper">
    <ul class="pagination">

        <!-- PREV -->
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a href="?page=<%= currentPage - 1 %>&search=<%= search %>">
                ‹ Prev
            </a>
        </li>

        <!-- PAGE NUMBERS -->
        <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a href="?page=<%= i %>&search=<%= search %>">
                    <%= i %>
                </a>
            </li>
        <% } %>

        <!-- NEXT -->
        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a href="?page=<%= currentPage + 1 %>&search=<%= search %>">
                Next ›
            </a>
        </li>

    </ul>
</div>
<% } %>


    </div>



    <!-- ADD BRAND MODAL -->
    <div id="addBrandModal" class="modal-overlay">
        <div class="modal-box brand-modal">
            <div class="modal-header">
                <h2>Add New Brand</h2>
                <span class="modal-close" onclick="closeAddBrandModal()">×</span>
            </div>

            <form id="addBrandForm" method="POST" action="/admin/brands/add" enctype="multipart/form-data">

                <div class="input-group">
                    <label>Brand Name</label>
                    <input type="text" name="name" required placeholder="Enter brand name">
                </div>

                <div class="input-group">
                    <label>Brand Logo</label>

                    <label class="file-upload-label">
                        <span id="fileNameAdd">Choose File</span>
                        <input type="file" name="logo" accept="image/*" required
                            onchange="previewFileName(event, 'fileNameAdd')">
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeAddBrandModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Add Brand</button>
                </div>
            </form>
        </div>
    </div>



    <!-- EDIT BRAND MODAL -->
    <div id="editBrandModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Edit Brand</h2>
                <span class="modal-close" onclick="closeEditBrandModal()">×</span>
            </div>

            <form id="editBrandForm" method="POST" enctype="multipart/form-data">
                <label>Brand Name</label>
                <input type="text" id="editName" name="name" required>

                <label>Brand Logo (Upload new if needed)</label>
                <input type="file" name="logo" accept="image/*">

                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditBrandModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Update Brand</button>
                </div>
            </form>

        </div>
    </div>


    <!-- CSS -->
    <style>
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(2px);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>


    <!-- JS -->
    <script>
        function openAddBrandModal() {
            document.getElementById("addBrandModal").style.display = "flex";
        }
        function closeAddBrandModal() {
            document.getElementById("addBrandModal").style.display = "none";
        }

        function openEditModal(id, name) {
            document.getElementById("editBrandModal").style.display = "flex";
            document.getElementById("editName").value = name;

            // Set form action for this specific brand
            document.getElementById("editBrandForm").action = `/admin/brands/edit/${id}`;
        }

        function closeEditBrandModal() {
            document.getElementById("editBrandModal").style.display = "none";
        }
        
        function previewFileName(event, targetId) {
            const file = event.target.files[0];
            document.getElementById(targetId).textContent = file ? file.name : "Choose File";
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function blockBrand(id, name) {
    Swal.fire({
      title: `Block ${name}?`,
      text: "Products under this brand will be hidden",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, block"
    }).then((result) => {
      if (result.isConfirmed) {
        axios.patch(`/admin/brands/${id}/block`)
          .then(() => location.reload());
      }
    });
  }

  function unblockBrand(id, name) {
    Swal.fire({
      title: `Unblock ${name}?`,
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, unblock"
    }).then((result) => {
      if (result.isConfirmed) {
        axios.patch(`/admin/brands/${id}/unblock`)
          .then(() => location.reload());
      }
    });
  }
</script>
