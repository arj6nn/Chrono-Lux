<%- include('../partials/admin/sidebar') %>

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/admin/category-management.css">

    <div class="main category-page-wrapper">
        <p class="page-title">Category Management</p>
        <p class="page-sub">Manage your product categories</p>

        <!-- TOP BAR -->
        <div class="top-bar">

            <!-- Backend Search -->
            <form action="/admin/categories" method="GET" class="search-form" style="display:flex; gap:10px;">
                <input class="search-box" type="text" name="search" placeholder="Search categories..."
                    value="<%= search %>" />

                <button type="submit" class="search-btn">Search</button>

                <% if (search && search.trim() !=="" ) { %>
                    <a href="/admin/categories" class="cancel-btn">Clear</a>
                    <% } %>
            </form>


            <!-- Add category -->
            <button class="add-category-btn" onclick="openAddCategoryModal()">
                <i class="ri-add-line"></i> Add Category
            </button>

        </div>

        <!-- TABLE -->
        <table class="category-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Offer (%)</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                <% categories.forEach(category=> { %>
                    <tr>

                        <!-- CATEGORY NAME + IMAGE -->
                        <td class="cell-name">
                            <img src="<%= category.categoryImage %>" width="45"
                                style="border-radius:6px; margin-right:8px;">
                            <%= category.name %>
                        </td>

                        <td class="cell-desc">
                            <%= category.description %>
                        </td>

                        <td>
                            <% if (category.categoryOffer> 0) { %>
                                <div style="display: flex; flex-direction: column;">
                                    <span style="font-weight: 600; color: #556b2f;">
                                        <%= category.categoryOffer %>%
                                    </span>
                                    <small style="color: #888; font-size: 11px;">
                                        <%= category.offerName %>
                                    </small>
                                </div>
                                <% } else { %>
                                    0%
                                    <% } %>
                        </td>

                        <!-- STATUS -->
                        <td>
                            <% if (category.isListed) { %>
                                <span class="status active">Active</span>
                                <% } else { %>
                                    <span class="status blocked">Inactive</span>
                                    <% } %>
                        </td>


                        <!-- ACTIONS -->
                        <td class="actions">

                            <i class="ri-edit-2-line edit" onclick='openEditCategoryModal(
                            "<%= category._id %>",
                            "<%= category.name %>",
                            "<%= category.description %>"
                        )'>
                            </i>

                            <% if (category.isListed) { %>
                                <i class="ri-forbid-line delete" title="Unlist Category"
                                    onclick="handleStatusToggle('<%= category._id %>', '<%= category.name %>', false)">
                                </i>
                                <% } else { %>
                                    <i class="ri-checkbox-circle-line edit" title="List Category"
                                        onclick="handleStatusToggle('<%= category._id %>', '<%= category.name %>', true)">
                                    </i>
                                    <% } %>

                        </td>

                    </tr>
                    <% }) %>
            </tbody>
        </table>

        <!-- PAGINATION -->
        <div class="pagination">
            <% if (page> 1) { %>
                <a class="page-btn" href="/admin/categories?page=<%= page - 1 %>&search=<%= search %>">
                    ‹ Prev
                </a>
                <% } else { %>
                    <span class="page-btn disabled">‹ Prev</span>
                    <% } %>

                        <div class="page-numbers">
                            <% for (let p=1; p <=totalPages; p++) { %>
                                <a href="/admin/categories?page=<%= p %>&search=<%= search %>"
                                    class="page-number <%= p === page ? 'active' : '' %>">
                                    <%= p %>
                                </a>
                                <% } %>
                        </div>

                        <% if (page < totalPages) { %>
                            <a class="page-btn" href="/admin/categories?page=<%= page + 1 %>&search=<%= search %>">
                                Next ›
                            </a>
                            <% } else { %>
                                <span class="page-btn disabled">Next ›</span>
                                <% } %>
        </div>


    </div>


    <!-- ADD CATEGORY MODAL -->
    <div id="addCategoryModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Add New Category</h2>
                <span class="modal-close" onclick="closeAddCategoryModal()">×</span>
            </div>

            <form id="addCategoryForm" enctype="multipart/form-data">

                <label>Category Name</label>
                <input type="text" name="name" id="addCatName" required>
                <span id="addNameError" class="error-message"></span>

                <label>Description</label>
                <input type="text" name="description" required>

                <label>Category Image</label>
                <div class="file-upload-wrapper">
                    <label for="editCatImage" class="custom-file-upload">
                        <i class="ri-upload-cloud-line"></i> Choose Image
                    </label>
                    <input id="editCatImage" type="file" name="image" accept="image/*" />
                    <span id="editFileName" class="file-name">No file chosen</span>
                </div>


                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeAddCategoryModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Add Category</button>
                </div>
            </form>
        </div>
    </div>


    <!-- EDIT CATEGORY MODAL -->
    <div id="editCategoryModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Edit Category</h2>
                <span class="modal-close" onclick="closeEditCategoryModal()">×</span>
            </div>

            <form id="editCategoryForm" method="POST" enctype="multipart/form-data">

                <label>Category Name</label>
                <input type="text" id="editCatName" name="name" required>
                <span id="editNameError" class="error-message"></span>

                <label>Description</label>
                <input type="text" id="editCatDesc" name="description" required>

                <label>Category Image (optional)</label>

                <div class="file-upload-wrapper">
                    <label for="editImageInput" class="custom-file-upload">
                        <i class="ri-upload-cloud-line"></i> Choose Image
                    </label>

                    <input id="editImageInput" type="file" name="image" accept="image/*">

                    <span id="editImageFileName" class="file-name">No file chosen</span>
                </div>

                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditCategoryModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Update Category</button>
                </div>
            </form>
        </div>
    </div>



    <!-- JS -->
    <script>

        /*ADD CATEGORY MODAL*/
        function openAddCategoryModal() {
            clearValidationErrors();
            document.getElementById("addCategoryModal").style.display = "flex";
        }

        function closeAddCategoryModal() {
            document.getElementById("addCategoryModal").style.display = "none";
            document.getElementById("addCategoryForm").reset();
            clearValidationErrors();
        }


        /*EDIT CATEGORY MODAL*/
        function openEditCategoryModal(id, name, desc) {
            clearValidationErrors();
            document.getElementById("editCategoryModal").style.display = "flex";

            document.getElementById("editCatName").value = name;
            document.getElementById("editCatDesc").value = desc;

            document.getElementById("editCategoryForm").action = `/admin/categories/edit/${id}`;
        }

        function closeEditCategoryModal() {
            document.getElementById("editCategoryModal").style.display = "none";
            document.getElementById("editCategoryForm").reset();
            clearValidationErrors();
        }

        function clearValidationErrors() {
            const errors = document.querySelectorAll(".error-message");
            const inputs = document.querySelectorAll("input.error");
            errors.forEach(el => el.style.display = "none");
            inputs.forEach(el => el.classList.remove("error"));
        }


        /* TOGGLE LIST/UNLIST WITH SWEETALERT */
        function handleStatusToggle(id, name, isListing) {
            const action = isListing ? "list" : "unlist";
            const confirmButtonText = isListing ? "Yes, list it" : "Yes, unlist it";
            const title = isListing ? `List ${name}?` : `Unlist ${name}?`;
            const text = isListing ? "This category will be visible to users." : "Products under this category will be hidden from users.";
            const icon = isListing ? "question" : "warning";

            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                showCancelButton: true,
                confirmButtonColor: isListing ? "#556b2f" : "#d9534f",
                cancelButtonColor: "#aaa",
                confirmButtonText: confirmButtonText
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/categories/toggle/${id}`, {
                        method: "PATCH"
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.reload();
                            } else {
                                Swal.fire("Error", data.message || "Something went wrong", "error");
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            window.location.reload(); // Fallback to reload if JSON parsing fails but action might have succeeded
                        });
                }
            });
        }


        /*FILE NAME UPDATE (ADD MODAL)*/
        document.getElementById("editCatImage").addEventListener("change", function () {
            const fileName = this.files[0] ? this.files[0].name : "No file chosen";
            document.getElementById("editFileName").textContent = fileName;
        });


        /*FILE NAME UPDATE (EDIT MODAL)*/
        document.getElementById("editImageInput").addEventListener("change", function () {
            const fileName = this.files[0] ? this.files[0].name : "No file chosen";
            document.getElementById("editImageFileName").textContent = fileName;
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            /* --- ADD CATEGORY AJAX --- */
            const addCategoryForm = document.getElementById("addCategoryForm");

            addCategoryForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                clearValidationErrors();

                const formData = new FormData(this);

                try {
                    const response = await fetch("/admin/categories/add", {
                        method: "POST",
                        body: formData
                    });

                    const data = await response.json();

                    if (!data.success) {
                        const nameInput = document.getElementById("addCatName");
                        const errorSpan = document.getElementById("addNameError");

                        nameInput.classList.add("error");
                        errorSpan.innerText = data.message;
                        errorSpan.style.display = "block";
                        return;
                    }

                    // ✅ SUCCESS ALERT (ONLY FOR ADD)
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: data.message,
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        closeAddCategoryModal();
                        window.location.reload();
                    });

                } catch (error) {
                    console.error(error);
                }
            });

            /* --- EDIT CATEGORY AJAX --- */
            const editCategoryForm = document.getElementById("editCategoryForm");

            editCategoryForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                clearValidationErrors();

                const formData = new FormData(this);
                const actionUrl = this.getAttribute("action");

                try {
                    const response = await fetch(actionUrl, {
                        method: "POST",
                        body: formData
                    });

                    const data = await response.json();

                    if (!data.success) {
                        const nameInput = document.getElementById("editCatName");
                        const errorSpan = document.getElementById("editNameError");

                        nameInput.classList.add("error");
                        errorSpan.innerText = data.message;
                        errorSpan.style.display = "block";
                        return;
                    }

                    // NO SWEETALERT FOR EDIT SUCCESS (AS PER REQUEST TO ONLY HAVE IT FOR ADDING)
                    closeEditCategoryModal();
                    window.location.reload();

                } catch (error) {
                    console.error(error);
                }
            });

            // Real-time error clearing
            document.querySelectorAll("input").forEach(input => {
                input.addEventListener("input", function () {
                    this.classList.remove("error");
                    const errorSpan = this.nextElementSibling;
                    if (errorSpan && errorSpan.classList.contains("error-message")) {
                        errorSpan.style.display = "none";
                    }
                });
            });

        });
    </script>